<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
 	   xmlns:tx="http://www.springframework.org/schema/tx"
	   xsi:schemaLocation="http://www.springframework.org/schema/beans 
						   http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
	                       http://www.springframework.org/schema/tx 
	                       http://www.springframework.org/schema/tx/spring-tx.xsd">
   
    
    <bean id="propertyConfigurer" class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
     <property name="location" value="WEB-INF/DBconfig.properties"/>
    </bean>
    <bean id="machineToolUpdateFreq" class="smtcl.mocs.web.webservice.model.MachineToolUpdateFreq"
	init-method="init" destroy-method="destory" scope="singleton"></bean>
	<!-- Spring Quartz -->
	<bean name="runMeJob" class="org.springframework.scheduling.quartz.JobDetailBean">
		<property name="jobClass" value="smtcl.mocs.web.webservice.model.RunMeJob" />
		<property name="jobDataAsMap">
		  <map>
			<entry key="machineToolUpdateFreq" value-ref="machineToolUpdateFreq" />
		  </map>
		</property>
	</bean>
	<bean id="cronTrigger" class="org.springframework.scheduling.quartz.CronTriggerBean">
		<property name="jobDetail" ref="runMeJob" />
		<property name="cronExpression" value="59 59 23 * * ?" />
	</bean>
	<bean name="runMeJob1" class="org.springframework.scheduling.quartz.JobDetailBean">
		<property name="jobClass" value="smtcl.mocs.web.webservice.model.RunMeJob1" />
		<property name="jobDataAsMap">
		  <map>
			<entry key="machineToolUpdateFreq" value-ref="machineToolUpdateFreq" />
		  </map>
		</property>
	</bean>
	<bean id="cronTrigger1" class="org.springframework.scheduling.quartz.CronTriggerBean">
		<property name="jobDetail" ref="runMeJob1" />
		<property name="cronExpression" value="0 0/1 * * * ?" />
	</bean>
	<bean class="org.springframework.scheduling.quartz.SchedulerFactoryBean">
		<property name="jobDetails">
	   		<list><ref bean="runMeJob" /> <ref bean="runMeJob1" /> </list>
		</property>
		<property name="triggers">
	    	<list><ref bean="cronTrigger" /> <ref bean="cronTrigger1" /></list>
		</property>
   </bean>
    <bean id="dataSource1" class="com.alibaba.druid.pool.DruidDataSource" init-method="init" destroy-method="close">
		<property name="url" value="${connection1.jdbcUrl}" />
      <property name="username" value="${connection1.user}" />
      <property name="password" value="${connection1.password}" />
		<!-- 配置初始化大小、最小、最大 -->
      <property name="initialSize" value="3" />
      <property name="minIdle" value="3" /> 
      <property name="maxActive" value="5" />

      <!-- 配置获取连接等待超时的时间 -->
      <property name="maxWait" value="60000" />

      <!-- 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒 -->
      <property name="timeBetweenEvictionRunsMillis" value="60000" />

      <!-- 配置一个连接在池中最小生存的时间，单位是毫秒 -->
      <property name="minEvictableIdleTimeMillis" value="300000" />

      <property name="validationQuery" value="SELECT 'x'" />
      <property name="testWhileIdle" value="true" />
      <property name="testOnBorrow" value="false" />
      <property name="testOnReturn" value="false" />

      <!-- 打开PSCache，并且指定每个连接上PSCache的大小 -->
      <property name="poolPreparedStatements" value="true" />
      <property name="maxPoolPreparedStatementPerConnectionSize" value="20" />
      
      
      <!-- 关闭长时间不使用的连接 -->
        <property name="removeAbandoned" value="true" /> <!-- 打开removeAbandoned功能 -->
        <property name="removeAbandonedTimeout" value="600" /> <!-- 1200秒，也就是20分钟 -->
        <property name="logAbandoned" value="true" /> <!-- 关闭abanded连接时输出错误日志 -->
        
	</bean>
	<bean id="sessionFactory" class="org.springframework.orm.hibernate3.annotation.AnnotationSessionFactoryBean">
		<property name="dataSource" ref="dataSource1" />
		<property name="packagesToScan">
			<list>
				<value>smtcl.mocs.pojos.device</value>
				<value>smtcl.mocs.pojos.authority</value>
				<value>smtcl.mocs.pojos.job</value>
				<value>smtcl.mocs.pojos.storage</value>
			</list>
		</property>
		<property name="hibernateProperties">
			<props>
                <prop key="hibernate.dialect">${connection1.dialect}</prop>
                <prop key="hibernate.show_sql">${connection1.show.sql}</prop>
                <prop key="hibernate.connection.release_mode">after_transaction</prop>
			</props>
		</property>
	</bean>

	<!-- atomikos事务管理器 -->
    <bean id="atomikosTransactionManager" class="com.atomikos.icatch.jta.UserTransactionManager" 
        init-method="init" destroy-method="close">
        <property name="forceShutdown" value="true"/>
    </bean>

    <bean id="atomikosUserTransaction" class="com.atomikos.icatch.jta.UserTransactionImp">
        <property name="transactionTimeout" value="300" />
    </bean>

    <!-- spring 事务管理器 -->
    <bean id="springTransactionManager"
        class="org.springframework.transaction.jta.JtaTransactionManager">
        <property name="transactionManager" ref="atomikosTransactionManager"/>
        <property name="userTransaction" ref="atomikosUserTransaction" />
        <property name="allowCustomIsolationLevels" value="true"/> 
    </bean>

    <!-- 使用annotation定义事务，对于要加入事物的类，只需对该类加 @Transactional  -->
    <tx:annotation-driven transaction-manager="springTransactionManager" />

<!--     hibernate Dao层模板 -->
<!--     <bean id="transactionManager" -->
<!--         class="org.springframework.orm.hibernate3.HibernateTemplate"> -->
<!--         <property name="sessionFactory" ref="sessionFactory"></property> -->
<!--     </bean> -->
    
	<bean id="transactionManager"
		class="org.springframework.orm.hibernate3.HibernateTransactionManager">
		<property name="sessionFactory" ref="sessionFactory" />
	</bean>
	      
    
	<!-- transaction manage -->
	<bean id="baseService"
		class="org.springframework.transaction.interceptor.TransactionProxyFactoryBean"
		abstract="true" lazy-init="true">
		<property name="transactionManager" ref="transactionManager" />
		<property name="transactionAttributes">
			<props>
				<prop key="*">PROPAGATION_REQUIRED</prop>
			</props>
		</property>
	</bean>

	<bean id="beanFactory" class="org.dreamwork.persistence.ServiceFactory" />

	<!-- generic type magic -->
	<bean id="abstractDaoTarget" abstract="true"
		class="org.dreamwork.persistence.hibernate.dao.impl.GenericHibernateDaoImpl">
		<property name="sessionFactory" ref="sessionFactory" />
	</bean>

	<bean id="abstractServiceTarget" abstract="true"
		class="org.dreamwork.persistence.GenericServiceSpringImpl" />

	<bean id="genericDao" class="org.springframework.aop.framework.ProxyFactoryBean"
		abstract="true" />

	<bean id="genericService" class="org.springframework.aop.framework.ProxyFactoryBean"
		abstract="true" />

	<bean id="commonDao" class="smtcl.mocs.dao.device.impl.CommonDaoImpl">
		<property name="sessionFactory" ref="sessionFactory" />
	</bean>

	<bean id="commonService1" parent="baseService">
		<property name="target">
			<bean
				class="smtcl.mocs.services.device.impl.CommonServiceImpl">
				<property name="commonDao" ref="commonDao" />
				<property name="dao">
					<bean parent="abstractDaoTarget">
						<constructor-arg value="java.lang.Object" />
					</bean>
				</property>
			</bean>
		</property>
	</bean>
	
	<!-- 权限调用Service -->
	<bean id="authorizeService" parent="baseService">
		<property name="target">
			<bean class="smtcl.mocs.services.device.impl.AuthorizeServiceImpl">
				<property name="dao">
					<bean parent="genericDao">
						<property name="target">
							<bean parent="abstractDaoTarget">
								<constructor-arg value="smtcl.mocs.pojos.device.TUser" />
							</bean>
						</property>
					</bean>
				</property>
			</bean>
		</property>
	</bean>
	

	<!-- 资源SERVICE -->
	<bean id="resourceService" parent="baseService">
		<property name="target">
			<bean
				class="smtcl.mocs.services.device.impl.ResourceServiceImpl">
				<property name="commonService" ref="commonService1" />	
				<property name="dao">
					<bean parent="genericDao">
						<property name="target">
							<bean parent="abstractDaoTarget">
								<constructor-arg
									value="smtcl.mocs.pojos.device.TUserResource" />
							</bean>
						</property>
					</bean>
				</property>
			</bean>
		</property>
	</bean>

	<!-- 产品SERVICE -->
	<bean id="productService" parent="baseService">
		<property name="target">
			<bean class="smtcl.mocs.services.device.impl.ProductServiceImpl">
				<property name="partService" ref="partService"/>
				<property name="dao">
					<bean parent="genericDao">
						<property name="target">
							<bean parent="abstractDaoTarget">
								<constructor-arg
									value="smtcl.mocs.pojos.device.TUserProducts" />
							</bean>
						</property>
					</bean>
				</property>
			</bean>
		</property>
	</bean>
	<!-- 产品service -->
	<bean id="productionService" parent="baseService">
		<property name="target">
			<bean
				class="smtcl.mocs.services.device.impl.ProductionImpl">
				<property name="dao">
					<bean parent="genericDao">
						<property name="target">
							<bean parent="abstractDaoTarget">
								<constructor-arg
									value="smtcl.mocs.pojos.device.TNodeProductionProfiles" />
							</bean>
						</property>
					</bean>
				</property>
			</bean>
		</property>
	</bean>

	<!-- 树Service -->
	<bean id="organizationService" parent="baseService">
		<property name="target">
			<bean
				class="smtcl.mocs.services.device.impl.OrganizationServiceImpl">
				<property name="dao">
					<bean parent="genericDao">
						<property name="target">
							<bean parent="abstractDaoTarget">
								<constructor-arg
									value="smtcl.mocs.pojos.device.TNodes" />
							</bean>
						</property>
					</bean>
				</property>
			</bean>
		</property>
	</bean>

	<!-- 用户查看设备总览Service -->
	<bean id="deviceService" parent="baseService">
		<property name="target">
			<bean class="smtcl.mocs.services.device.impl.DeviceServiceImpl">
                <property name="remoteCommonService" ref="remoteCommonService" />
				<property name="commonService" ref="commonService1" />
				<property name="dao">
					<bean parent="genericDao">
						<property name="target">
							<bean parent="abstractDaoTarget">
								<constructor-arg
									value="smtcl.mocs.pojos.device.TNodes" />
							</bean>
						</property>
					</bean>
				</property>
			</bean>
		</property>
	</bean>
	
	 	<!-- 作业计划SERVICE --> 
<!-- 	<bean id="jobPlanService" parent="baseService"> -->
<!-- 		<property name="target"> -->
<!-- 			<bean class="smtcl.mocs.services.jobplan.impl.JobPlanServiceImpl"> -->
<!-- 			<property name="commonService" ref="commonService1"/> -->
<!-- 			<property name="commonDao" ref="commonDao" /> -->
<!-- 				<property name="dao"> -->
<!-- 					<bean parent="genericDao"> -->
<!-- 						<property name="target"> -->
<!-- 							<bean parent="abstractDaoTarget"> -->
<!-- 								<constructor-arg value="smtcl.mocs.pojos.job.TJobplanInfo" /> -->
<!-- 							</bean> -->
<!-- 						</property> -->
<!-- 					</bean> -->
<!-- 				</property> -->
<!-- 			</bean> -->
<!-- 		</property> -->
<!-- 	</bean> -->
	
	<!-- 设备管理SERVICE -->
	<bean id="equipmentService" parent="baseService">
		<property name="target">
			<bean class="smtcl.mocs.services.jobplan.impl.EquipmentServiceImpl">
			<property name="commonService" ref="commonService1"/>
			<property name="commonDao" ref="commonDao" />
				<property name="dao">
					<bean parent="genericDao">
						<property name="target">
							<bean parent="abstractDaoTarget">
								<constructor-arg value="smtcl.mocs.pojos.job.TEquipmentCostInfo" />
							</bean>
						</property>
					</bean>
				</property>
			</bean>
		</property>
	</bean>
	
	<!-- 人员管理SERVICE -->
	<bean id="memberService" parent="baseService">
		<property name="target">
			<bean class="smtcl.mocs.services.device.impl.MemberServiceImpl">
				<property name="commonService" ref="commonService1" />
				<property name="dao">
					<bean parent="genericDao">
						<property name="target">
							<bean parent="abstractDaoTarget">
								<constructor-arg value="smtcl.mocs.pojos.job.TMemberInfo" />
							</bean>
						</property>
					</bean>
				</property>
			</bean>
		</property>
	</bean>
	
	<!-- 工单SERVICE -->
<!-- 	<bean id="jobDispatchService" parent="baseService"> -->
<!-- 		<property name="target"> -->
<!-- 			<bean class="smtcl.mocs.services.jobplan.impl.JobDispatchServiceImpl"> -->
<!-- 				<property name="dao"> -->
<!-- 					<bean parent="genericDao"> -->
<!-- 						<property name="target"> -->
<!-- 							<bean parent="abstractDaoTarget"> -->
<!-- 								<constructor-arg value="smtcl.mocs.pojos.job.TJobdispatchlistInfo" /> -->
<!-- 							</bean> -->
<!-- 						</property> -->
<!-- 					</bean> -->
<!-- 				</property> -->
<!-- 			</bean> -->
<!-- 		</property> -->
<!-- 	</bean> -->
	
	<bean id="mtService" parent="baseService">
		<property name="target">
			<bean class="smtcl.mocs.services.device.impl.MtServiceImpl">
				<property name="commonService" ref="commonService1" />
				<property name="dao">
					<bean parent="genericDao">
						<property name="target">
							<bean parent="abstractDaoTarget">
								<constructor-arg
									value="smtcl.mocs.pojos.device.TMachinesInfo" />
							</bean>
						</property>
					</bean>
				</property>
			</bean>
		</property>
	</bean>
	
	
	<bean id="wsBZService" parent="baseService">
		<property name="target">
			<bean
				class="smtcl.mocs.services.device.impl.WSBZServiceImpl">
				<property name="commonService" ref="commonService1" />				
				<property name="dao">
					<bean parent="genericDao">
						<property name="target">
							<bean parent="abstractDaoTarget">
								<constructor-arg
									value="smtcl.mocs.pojos.device.TNodes" />
							</bean>
						</property>
					</bean>
				</property>
			</bean>
		</property>
	</bean>
	
	<!-- 成本管理Service -->
	<bean id="costManageService" parent="baseService">
		<property name="target">
			<bean
				class="smtcl.mocs.services.device.impl.CostManageServiceImpl">
				<property name="commonService" ref="commonService1" />
				<property name="remoteCommonService" ref="remoteCommonService" />
				<property name="commonDao" ref="commonDao" />
				<property name="dao">
					<bean parent="genericDao">
						<property name="target">
							<bean parent="abstractDaoTarget">
								<constructor-arg
									value="smtcl.mocs.pojos.device.TNodes" />
							</bean>
						</property>
					</bean>
				</property>
			</bean>
		</property>
	</bean>
	
	<!-- 零件Service -->
	<!-- 
	<bean id="partService" class="smtcl.mocs.services.device.impl.PartServiceImp">
		<property name="commonDao" ref="commonDao" />
	</bean> -->
	<bean id="partService" parent="baseService">
		<property name="target">
			<bean
				class="smtcl.mocs.services.device.impl.PartServiceImp">
				<property name="commonDao" ref="commonDao" />
				<property name="dao">
					<bean parent="genericDao">
						<property name="target">
							<bean parent="abstractDaoTarget">
								<constructor-arg
									value="smtcl.mocs.pojos.device.TNodes" />
							</bean>
						</property>
					</bean>
				</property>
			</bean>
		</property>
	</bean>
	
	<!-- 登录和获取权限webservice配置 -->
	<bean id="wsUserService" parent="baseService">
		<property name="target">
			<bean
				class="smtcl.mocs.services.device.impl.WSUserServiceImpl">
                <property name="remoteCommonService" ref="remoteCommonService" />
				<property name="dao">
					<bean parent="genericDao">
						<property name="target">
							<bean parent="abstractDaoTarget">
								<constructor-arg value="smtcl.mocs.pojos.device.TUser" />
							</bean>
						</property>
					</bean>
				</property>
			</bean>
		</property>
	</bean>
	

	
	<!-- processService -->
	<bean id="processService" parent="baseService">
		<property name="target">
			<bean
				class="smtcl.mocs.services.device.impl.ProcessServiceImpl">
				<property name="dao">
					<bean parent="genericDao">
						<property name="target">
							<bean parent="abstractDaoTarget">
								<constructor-arg
									value="smtcl.mocs.pojos.job.TProcessInfo" />
							</bean>
						</property>
					</bean>
				</property>
			</bean>
		</property>
	</bean>
	
	<!-- 报表数据服务  -->
<!-- 	<bean id="reportService" parent="baseService"> -->
<!-- 		<property name="target"> -->
<!-- 			<bean class="smtcl.mocs.services.report.impl.ReportServiceImpl"> -->
<!-- 				<property name="dao"> -->
<!-- 					<bean parent="genericDao"> -->
<!-- 						<property name="target"> -->
<!-- 							<bean parent="abstractDaoTarget"> -->
<!-- 								<constructor-arg -->
<!-- 									value="java.lang.Object" /> -->
<!-- 							</bean> -->
<!-- 						</property> -->
<!-- 					</bean> -->
<!-- 				</property> -->
<!-- 			</bean> -->
<!-- 		</property> -->
<!-- 	</bean> -->
	<!-- 库存物料查询 -->
		<bean id="materielManageService" parent="baseService">
		<property name="target">
			<bean class="smtcl.mocs.services.storage.impl.MaterielManageServiceImpl">
				<property name="dao">
					<bean parent="genericDao">
						<property name="target">
							<bean parent="abstractDaoTarget">
								<constructor-arg
									value="java.lang.Object" />
							</bean>
						</property>
					</bean>
				</property>
			</bean>
		</property>
	</bean>
	<!-- 库房库存管理Service -->
	<bean id="storageManage" parent="baseService">
		<property name="target">
			<bean class="smtcl.mocs.services.storage.impl.StorageManageImpl">
				<property name="dao">
					<bean parent="genericDao">
						<property name="target">
							<bean parent="abstractDaoTarget">
								<constructor-arg
									value="java.lang.Object" />
							</bean>
						</property>
					</bean>
				</property>
			</bean>
		</property>
	</bean>
<!-- 单位设置SERVICE -->
	<bean id="setunitService" parent="baseService">
		<property name="target">
			<bean class="smtcl.mocs.services.storage.impl.SetUnitServiceImpl">
			<property name="commonService" ref="commonService1" />	
			<property name="dao">
					<bean parent="genericDao">
						<property name="target">
							<bean parent="abstractDaoTarget">
								<constructor-arg value="smtcl.mocs.pojos.storage.TUnitType" />
							</bean>
						</property>
					</bean>
				</property>
			</bean>
		</property>
	</bean>
	<!-- 定时器配置start -->
	 <!--  
	<bean class="org.springframework.scheduling.quartz.SchedulerFactoryBean">  
        <property name="triggers">  
            <list>  
                 <ref local="BusinessTestTrigger" /> 
            </list>  
        </property>  
    </bean> 
    
    <bean id="BusinessTestTrigger"  
        class="org.springframework.scheduling.quartz.CronTriggerBean">  
        <property name="jobDetail">  
            <ref bean="BusinessTestDetail" />  
        </property>  
        <property name="cronExpression">  
            <value>0 0/1 * * * ?</value>  
        </property>  
    </bean> 
    
    <bean id="BusinessTestTime" class="smtcl.mocs.common.device.ProcessMachineStopJob"/>  
    
    <bean id="BusinessTestDetail"  
        class="org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean">  
        <property name="targetObject">  
              <ref bean="BusinessTestTime" /> 
        </property>  
        <property name="concurrent" value="false" />  
        <property name="targetMethod" value="run" />  
    </bean> 
     -->
    <!-- 定时器配置end -->  
</beans>
